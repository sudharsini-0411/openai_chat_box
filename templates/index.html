<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ü§ñ Talk to Jingly</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: skyblue;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .chat-container {
      background-color: pink;
      padding: 80px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      width: 800px;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      color: #444;
      margin-bottom: 20px;
    }

    select, input[type="text"], button {
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    #chat-box {
      background-color: #f7f9fa;
      padding: 15px;
      border-radius: 10px;
      height: 350px; /* Increased height */
      overflow-y: auto;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
    }

    .message {
      padding: 12px 18px;
      border-radius: 20px;
      margin: 6px 0;
      max-width: 80%;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 15px;
    }

    .bot {
      background-color: #e4e9f3;
      align-self: flex-start;
    }

    .user {
      background-color: #c2edd4;
      align-self: flex-end;
    }

    .message img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .button-voice {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .icon {
      font-size: 18px;
    }

    .button-voice:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .listening {
      background-color: #ff6b6b !important;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <h1>ü§ñ Talk to Jingly</h1>

    <div>
      <label for="personality">Select Personality:</label>
      <select id="personality">
        <option value="Formal">Formal</option>
        <option value="Funny">Funny</option>
        <option value="Friendly">Friendly</option>
        <option value="Tutor">Tutor</option>
      </select>
    </div>

    <div class="input-row">
      <input type="text" id="user-input" placeholder="Type your message here..." />
      <button onclick="sendMessage()">Send</button>
      <button onclick="startVoice()" class="button-voice">üé§ Voice</button>
      <button onclick="document.getElementById('file-input').click()" class="button-voice">üìé Upload</button>
      <button onclick="generateImage()" class="button-voice">üé® Generate</button>
      <button onclick="readAloud()" class="button-voice">üîä Read</button>
      <button onclick="showFiles()" class="button-voice">üìÅ Files</button>
    </div>
    
    <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg,.gif" style="display: none;" onchange="handleFileUpload(event)">

    <div id="chat-box"></div>
  </div>

  <script>
    let lastBotMessage = "";
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;

    function appendMessage(message, sender, isError = false) {
      const chatBox = document.getElementById("chat-box");
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${sender}${isError ? ' error' : ''}`;
      
      if (typeof message === 'string' && message.includes('<')) {
        msgDiv.innerHTML = message;
      } else {
        msgDiv.innerText = message;
      }
      
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      appendMessage(`üìé Uploading ${file.name}...`, "user");

      fetch("/upload", {
        method: "POST",
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          appendMessage(`‚ùå ${data.error}`, "bot", true);
        } else if (data.success && data.file_info) {
          const info = data.file_info;
          let infoMessage = `‚úÖ File uploaded successfully!\n\n`;
          infoMessage += `üìÅ Name: ${info.filename}\n`;
          infoMessage += `üìè Size: ${(info.size / 1024).toFixed(2)} KB\n`;
          infoMessage += `üìã Type: ${info.type.toUpperCase()}\n`;
          if (info.pages) {
            infoMessage += `üìñ Pages: ${info.pages}\n`;
          }
          infoMessage += `üíæ Saved to: uploads/${info.filename}\n`;
          
          appendMessage(infoMessage, "bot");
          
          if (info.content && info.content.length > 0) {
            appendMessage(`üìÑ Content Preview:\n${info.content}`, "bot");
          }
        }
      })
      .catch(err => {
        appendMessage(`‚ùå Upload error: ${err.message}`, "bot", true);
      });
      
      event.target.value = '';
    }

    function readAloud() {
      // If currently reading, stop it
      if (currentUtterance && speechSynthesis.speaking) {
        speechSynthesis.cancel();
        currentUtterance = null;
        document.querySelector('.button-voice:last-child').innerHTML = 'üîä Read';
        return;
      }

      if (!lastBotMessage) {
        alert("No message to read aloud");
        return;
      }

      if ('speechSynthesis' in window) {
        currentUtterance = new SpeechSynthesisUtterance(lastBotMessage);
        currentUtterance.rate = 0.8;
        currentUtterance.pitch = 1;
        
        currentUtterance.onstart = function() {
          document.querySelector('.button-voice:last-child').innerHTML = '‚èπÔ∏è Stop';
        };
        
        currentUtterance.onend = function() {
          currentUtterance = null;
          document.querySelector('.button-voice:last-child').innerHTML = 'üîä Read';
        };
        
        currentUtterance.onerror = function() {
          currentUtterance = null;
          document.querySelector('.button-voice:last-child').innerHTML = 'üîä Read';
        };
        
        speechSynthesis.speak(currentUtterance);
      } else {
        alert("Speech synthesis not supported in this browser");
      }
    }

    function sendMessage() {
      const input = document.getElementById("user-input");
      const message = input.value.trim();
      const personality = document.getElementById("personality").value;

      if (message === "") return;

      appendMessage(message, "user");
      input.value = "";

      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, personality })
      })
      .then(res => res.json())
      .then(data => {
        appendMessage(data.response, "bot");
        lastBotMessage = data.response;
      })
      .catch(err => {
        appendMessage("Error: " + err.message, "bot");
      });
    }

    function startVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("Voice input not supported in this browser");
        return;
      }

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      // Show listening indicator
      const voiceBtn = document.querySelector('.button-voice');
      const originalText = voiceBtn.innerHTML;
      voiceBtn.innerHTML = 'üéôÔ∏è Listening...';
      voiceBtn.disabled = true;
      
      recognition.start();

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById("user-input").value = transcript;
        voiceBtn.innerHTML = originalText;
        voiceBtn.disabled = false;
        sendMessage();
      };

      recognition.onerror = function(event) {
        voiceBtn.innerHTML = originalText;
        voiceBtn.disabled = false;
        
        let errorMessage = "Voice input error: ";
        switch(event.error) {
          case 'no-speech':
            errorMessage += "No speech detected. Please try again.";
            break;
          case 'audio-capture':
            errorMessage += "Microphone not available.";
            break;
          case 'not-allowed':
            errorMessage += "Microphone access denied.";
            break;
          case 'network':
            errorMessage += "Network error occurred.";
            break;
          default:
            errorMessage += event.error;
        }
        alert(errorMessage);
      };

      recognition.onend = function() {
        voiceBtn.innerHTML = originalText;
        voiceBtn.disabled = false;
      };
    }

    function generateImage() {
      const input = document.getElementById("user-input");
      const prompt = input.value.trim();
      
      if (prompt === "") {
        alert("Please enter a description for the image you want to generate");
        return;
      }
      
      appendMessage(`üé® Generating image: "${prompt}"`, "user");
      input.value = "";
      
      fetch("/generate-image", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ prompt: prompt })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          appendMessage(`‚ùå ${data.error}`, "bot", true);
        } else if (data.success && data.image_url) {
          const chatBox = document.getElementById("chat-box");
          const msgDiv = document.createElement("div");
          msgDiv.className = "message bot";
          msgDiv.innerHTML = `
            <p>‚úÖ Generated image for: "${data.prompt}"</p>
            <img src="${data.image_url}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          `;
          chatBox.appendChild(msgDiv);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      })
      .catch(err => {
        appendMessage(`‚ùå Image generation error: ${err.message}`, "bot", true);
      });
    }

    function showFiles() {
      appendMessage("üìÅ Loading files from upload folder...", "user");
      
      fetch("/files", {
        method: "GET"
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          appendMessage(`‚ùå ${data.error}`, "bot", true);
        } else if (data.files && data.files.length > 0) {
          let filesMessage = `üìÇ Upload Folder Contents (${data.files.length} files):\n\n`;
          
          data.files.forEach((file, index) => {
            const date = new Date(file.modified * 1000).toLocaleDateString();
            filesMessage += `${index + 1}. üìÑ ${file.filename}\n`;
            filesMessage += `   üìè Size: ${(file.size / 1024).toFixed(2)} KB\n`;
            filesMessage += `   üìÖ Modified: ${date}\n\n`;
          });
          
          appendMessage(filesMessage, "bot");
        } else {
          appendMessage("üìÇ Upload folder is empty. No files found.", "bot");
        }
      })
      .catch(err => {
        appendMessage(`‚ùå Error loading files: ${err.message}`, "bot", true);
      });
    }
    
  </script>
</body>
</html>
